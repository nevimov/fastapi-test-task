{"version":3,"file":"main.js","sources":["src/page_login.js","src/utils.js","src/page_my_urls.js"],"sourcesContent":["import { alertError, setJwtToken } from './utils'\n\n;(function() {\n  const urls = window.urls\n\n  $(\"#login-form\").on(\"submit\", function (event) {\n    event.preventDefault()\n    const form = this\n\n    if (form.checkValidity() === false) {\n      return\n    }\n\n    const $form = $(form)\n    const postUrl = $form.attr('action')\n    const postData = $form.serialize()\n\n    $.post(postUrl, postData)\n      .done(function(data) {\n        // On success, save the token and redirect the user to the \"My URLs\" page\n        setJwtToken(data[\"access_token\"])\n        window.location.href = urls.pages.MY_URLS\n      })\n      .fail(function(xhr, textStatus, errorThrown) {\n        if (xhr.readyState == 0) {\n          // Network error (connection refused, access denied due to CORS, etc.)\n          alertError(\n            \"Can't connect with the server. \" +\n            \"Please check your network connection or try again later.\"\n          )\n        }\n        else if (xhr.readyState < 4) {\n          // Something weird is happening\n          alertError(\"An unknown error occurred. Please try again later.\")\n        }\n        else {\n          const errorMsg = xhr.responseJSON[\"detail\"]\n          alertError(errorMsg)\n        }\n      })\n\n  })\n})()\n","// Get an API access token required to interact with the most of API methods.\nexport function getJwtToken() {\n  return window.localStorage.getItem('jwt_token')\n}\n\n// Set the stored API access token to a new value.\nexport function setJwtToken(value) {\n  return window.localStorage.setItem('jwt_token', value)\n}\n\n\n// A class providing methods to interact with the site API.\nexport class ApiClient {\n\n  constructor (jwt_token) {\n    this.jwt_token = jwt_token\n  }\n\n  get(url, data) {\n    return this._makeRequest(\"GET\", url, data)\n  }\n\n  post(url, data) {\n    return this._makeRequest(\"POST\", url, data)\n  }\n\n  _makeRequest(httpMethod, url, data, errorHandler) {\n    const that = this\n\n    let ajaxRequestOpts = {\n      type: httpMethod,\n      url: url,\n      data: data,\n      headers: {\n        Authorization: 'Bearer ' + that.jwt_token\n      },\n      contentType : 'application/json',\n      dataType: 'json',\n    }\n\n    // Set a default error handler, if `errorHandler` is not provided.\n    errorHandler = errorHandler || function(xhr, textStatus, errorThrown) {\n      if (xhr.readyState == 0) {\n        // Network error (connection refused, access denied due to CORS, etc.)\n        alertError(\n          \"Can't connect with the server. \" +\n          \"Please check your network connection or try again later.\"\n        )\n      }\n      else if (xhr.readyState < 4) {\n        // Something weird is happening\n        alertError(\"An unknown error occurred. Please try again later.\")\n      }\n    }\n    if (errorHandler) {\n      ajaxRequestOpts[\"error\"] = errorHandler\n    }\n\n    return $.ajax(ajaxRequestOpts)\n  }\n}\n\n\n// Display an ERROR message to the user.\nexport function alertError(content) {\n  _showAlert('alert-danger',   content)\n}\n\n// Display a SUCCESS message to the user.\nexport function alertSuccess(content) {\n  _showAlert('alert-success', content)\n}\n\nfunction _showAlert(cls, content) {\n  const alertHtml = `\n  <div class=\"alert ${cls} alert-dismissible top fade show\" role=\"alert\">\n    <div class=\"alert-content\"> ${content} </div>\n    <button type=\"button\" class=\"close\" data-dismiss=\"alert\">\n      <span>&times;</span>\n    </button>\n  </div>\n  `\n  $('body').prepend(alertHtml)\n}\n\n\n// Remove CSS classes used by Bootstrap v4 to mark form field errrors.\n// `form` can be a CSS selector, a DOM element or a jQuery element.\nexport function clearFormErrors(form) {\n  const $form = $(form)\n  $form.find(\".invalid-feedback\").remove()\n  $form.find(\".is-invalid\").removeClass('is-invalid')\n}","import { ApiClient, alertSuccess, alertError, getJwtToken, clearFormErrors } from './utils'\n\n;(function() {\n  const urls = window.urls\n\n  // The code in this module is specific to the \"My URLs\" page\n  if (window.location.href !== urls.pages.MY_URLS) {\n    return\n  }\n\n  // If the user is not authenticated, redirect him to the login page.\n  const jwt_token = getJwtToken()\n  if (!jwt_token) {\n    window.location.replace(urls.pages.LOGIN)\n  }\n\n  const apiClient = new ApiClient(jwt_token)\n\n\n  // ***************************\n  // *** Paginated URL Table ***\n  // ***************************\n\n  const URLS_PER_PAGE = 25\n\n  const $urlTableSpinner = $('#my-urls-table-spinner')\n  const $urlTableBody = $('#my-urls-table tbody')\n  const $urlPagination = $('#my-urls-pagination')\n\n\n  // Display user URLs\n  function displayUrls(skip, limit) {\n    skip = skip || 0\n    limit = limit || URLS_PER_PAGE\n\n    $urlTableSpinner.show()\n\n    const xhr = apiClient.get(\n      urls.api.GET_MY_URLS,\n      {skip: skip, limit: limit}\n    )\n\n    xhr.done(function (data, textStatus, xhr) {\n      const urls = data\n      // Populate the URL table\n      for (let i = 0; i < urls.length; i++) {\n        const url = urls[i]\n        const shortUrl = `${location.protocol}//${location.host}/${url.key}`\n        const originalUrl = url.destination\n        $urlTableBody.append(`\n          <tr>\n            <td>${i+1}</td>\n            <td><a href=\"${originalUrl}\">${originalUrl}</a></td>\n            <td><a href=\"${shortUrl}\">/${url.key}</td>\n          </tr>\n        `)\n      }\n      createPagination(xhr)\n    })\n\n    xhr.fail(function(xhr, textStatus, errorThrown) {\n      if (xhr.readyState !== 4) {\n        return\n      }\n      const errorMsg = xhr.responseJSON[\"detail\"]\n      alertError(errorMsg)\n    })\n\n    xhr.always(function (xhr, textStatus) {\n      $urlTableSpinner.hide()\n    })\n  }\n\n\n  // Clear the URL table\n  function clearUrls() {\n    $urlTableBody.empty()\n  }\n\n\n  // Function to run when a pagination link is clicked\n  function changeUrlsPage(event) {\n    clearUrls()\n    displayUrls(event.data.skip, URLS_PER_PAGE)\n  }\n\n  // Create (or recreate) pagination links for the URL table\n  function createPagination(xhr) {\n    $urlPagination.empty()\n    const totalUrlCount = xhr.getResponseHeader('X-User-Url-Count')\n    const pageCount = Math.ceil(totalUrlCount / URLS_PER_PAGE)\n    for (let i = 1; i <= pageCount; i++) {\n      const $link = $(\n        `<li class=\"page-item\"> <a href=\"#!\" class=\"page-link\">${i}</a> </li>`\n      )\n      $link.on(\"click\", {skip: (i - 1) * URLS_PER_PAGE}, changeUrlsPage)\n      $urlPagination.append($link)\n    }\n  }\n\n\n  // Init. Display the first page.\n  displayUrls()\n\n\n  // ******************************\n  // *** \"Add a Short URL\" Form ***\n  // ******************************\n\n  $(\"#add-url-form\").on(\"submit\", function (event) {\n    event.preventDefault()\n    const form = this\n\n    if (form.checkValidity() === false) {\n      return\n    }\n\n    const $form = $(form)\n    const redirectTo = $form.find('[name=\"destination\"]').val()\n    const redirectFrom = $form.find('[name=\"key\"]').val()\n    let requestData = {\n      \"destination\": redirectTo,\n    }\n    if (redirectFrom) {\n      requestData[\"key\"] = redirectFrom\n    }\n    requestData = JSON.stringify(requestData)\n    const xhr = apiClient.post(urls.api.ADD_URL, requestData)\n\n    xhr.done(function (data, status, xhr) {\n      clearFormErrors($form)\n      clearUrls()\n      displayUrls()\n      createPagination(xhr)\n      const longUrlLink = `<a href=\"${data['destination']}\">${data['destination']}</a>`\n      const shortUrl = `${location.protocol}//${location.host}/${data[\"key\"]}`\n      const shortUrlLink = `<a href=\"${shortUrl}\">${shortUrl}</a>`\n      alertSuccess(`Success! Created redirect from ${shortUrlLink} to ${longUrlLink}.`)\n    })\n\n    xhr.fail(function(xhr, textStatus, errorThrown) {\n      if (xhr.readyState !== 4) {\n        return\n      }\n\n      clearFormErrors($form)\n      const errDetail = xhr.responseJSON[\"detail\"]\n      if (typeof errDetail === \"string\") {\n        alertError(`${errDetail}`)\n        return\n      }\n      for (let i = 0; i < errDetail.length; i++) {\n        const error = errDetail[i]\n        const fieldName = error[\"loc\"][1]\n        const $field = $form.find(`[name=\"${fieldName}\"]`)\n        $field.addClass(\"is-invalid\")\n        $field.parent().append(`<div class=\"invalid-feedback\">${error[\"msg\"]}</div>`)\n      }\n    })\n\n  })\n\n  console.log('done')\n})()\n"],"names":["urls","ApiClient","jwt_token","get","url","data","this","_makeRequest","post","httpMethod","errorHandler","ajaxRequestOpts","type","headers","Authorization","contentType","dataType","xhr","textStatus","errorThrown","readyState","alertError","$","ajax","content","_showAlert","cls","alertHtml","prepend","clearFormErrors","form","$form","find","remove","removeClass","window","on","event","preventDefault","checkValidity","postUrl","attr","postData","serialize","done","value","localStorage","setItem","location","href","pages","MY_URLS","fail","responseJSON","getItem","replace","LOGIN","apiClient","$urlTableSpinner","$urlTableBody","$urlPagination","displayUrls","redirectTo","val","redirectFrom","requestData","JSON","stringify","api","ADD_URL","status","clearUrls","createPagination","longUrlLink","shortUrl","protocol","host","errDetail","i","length","error","fieldName","$field","addClass","parent","append","console","log","skip","limit","show","GET_MY_URLS","key","originalUrl","destination","always","hide","empty","changeUrlsPage","totalUrlCount","getResponseHeader","pageCount","Math","ceil","$link"],"mappings":"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"}